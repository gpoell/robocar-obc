services:

  mqtt-broker:
    image: eclipse-mosquitto:latest
    container_name: mqtt-broker
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto/config/mosquitto.conf:/mosquitto/config/mosquitto.conf
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/logs:/mosquitto/logs
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 256M


  tests:
    build:
      context: ./
      dockerfile: ./src/services/unittests/Dockerfile
    command: python -m unittest discover -s tests
    container_name: tests
    environment:
      - ENVIRON=${ENVIRON}
    privileged: true
    develop:
      watch:
        - action: sync
          path: ./src/tests
          target: ./app/tests
        - action: sync
          path: ./src/parts
          target: ./app/tests/parts
        - action: sync
          path: ./src/client
          target: ./app/tests/client
    depends_on:
      - mqtt-broker


  app:
    build: ./src/app
    tty: true
    container_name: app
    volumes:
      - ./src/app:/app
    environment:
      - ENVIRON=${ENVIRON}


  vehicle:
    build: ./src/vehicle
    tty: true
    container_name: vehicle
    volumes:
      - ./src/vehicle:/app
      - ./src/client:/app/client
      - ./src/motor:/app/motor
    privileged: true
    environment:
      - ENVIRON=${ENVIRON}


  ultrasonic:
    build: ./src/sensors/ultrasonic
    tty: true
    container_name: sensor-ultrasonic
    volumes:
      - ./src/sensors/ultrasonic:/app
      - ./src/client:/app/client

    working_dir: /app
    privileged: true
    environment:
      - ENVIRON=${ENVIRON}


  infrared:
    build: ./src/sensors/infrared
    tty: true
    container_name: infrared
    volumes:
      - ./src/sensors/infrared:/app
      - ./src/client:/app/client

    working_dir: /app
    privileged: true
    environment:
      - ENVIRON=${ENVIRON}
